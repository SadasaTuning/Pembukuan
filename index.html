<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pembukuan Pendapatan</title>
    <meta name="description" content="Aplikasi pembukuan pendapatan bulanan">
    <meta name="theme-color" content="#6366f1"/>
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/png" href="./icon-192.png">
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --dark: #1f2937;
            --darker: #111827;
            --light: #f8fafc;
            --gray: #6b7280;
            --gray-light: #9ca3af;
            --border: #374151;
            --card-bg: #1f2937;
        }

        [data-theme="light"] {
            --dark: #f8fafc;
            --darker: #e2e8f0;
            --light: #1f2937;
            --card-bg: #ffffff;
            --border: #e5e7eb;
            --gray: #6b7280;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--light);
            transition: all 0.3s ease;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: var(--card-bg);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            border: 1px solid var(--border);
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        h1 {
            color: var(--light);
            font-size: 1.5em;
            font-weight: 700;
        }
        
        .install-btn {
            background: var(--primary);
            border: none;
            padding: 10px 15px;
            border-radius: 12px;
            cursor: pointer;
            color: white;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .install-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }
        
        .install-btn.hidden {
            display: none;
        }
        
        .theme-toggle {
            background: var(--primary);
            border: none;
            padding: 10px;
            border-radius: 12px;
            cursor: pointer;
            color: white;
            transition: all 0.3s ease;
        }
        
        .theme-toggle:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }
        
        .tab-navigation {
            display: flex;
            margin-bottom: 20px;
            background: var(--darker);
            border-radius: 15px;
            padding: 6px;
            gap: 5px;
        }
        
        .tab-button {
            flex: 1;
            padding: 12px;
            text-align: center;
            background: transparent;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            color: var(--gray-light);
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .tab-button.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        
        .tab-button:hover:not(.active) {
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary);
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .tab-content.active {
            display: block;
        }
        
        .input-section {
            background: var(--darker);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }
        
        input, button, select, textarea {
            width: 100%;
            padding: 14px;
            margin: 8px 0;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 16px;
            font-family: inherit;
            transition: all 0.3s ease;
        }
        
        input, textarea, select {
            background: var(--dark);
            color: var(--light);
            border-color: var(--border);
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        input::placeholder {
            color: var(--gray-light);
        }
        
        button {
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        button:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .button-group button {
            flex: 1;
        }
        
        .summary {
            background: linear-gradient(135deg, var(--secondary), #059669);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            text-align: center;
            color: white;
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }
        
        .total {
            font-size: 2em;
            font-weight: 700;
            margin-top: 5px;
        }
        
        .month-summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .month-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }
        
        .month-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }
        
        .month-card.previous {
            border-left: 4px solid var(--info);
        }
        
        .month-card.current {
            border-left: 4px solid var(--secondary);
        }
        
        .month-card h3 {
            font-size: 14px;
            color: var(--gray-light);
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .month-card .amount {
            font-size: 1.4em;
            font-weight: 700;
        }
        
        .month-card.previous .amount {
            color: var(--info);
        }
        
        .month-card.current .amount {
            color: var(--secondary);
        }
        
        .transactions {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 5px;
        }
        
        .transactions::-webkit-scrollbar {
            width: 6px;
        }
        
        .transactions::-webkit-scrollbar-track {
            background: var(--darker);
            border-radius: 10px;
        }
        
        .transactions::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }
        
        .transaction-item {
            background: var(--card-bg);
            padding: 16px;
            margin: 10px 0;
            border-radius: 12px;
            border-left: 4px solid var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }
        
        .transaction-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .transaction-desc {
            flex: 1;
        }
        
        .transaction-desc strong {
            color: var(--light);
            display: block;
            margin-bottom: 4px;
        }
        
        .transaction-date {
            font-size: 12px;
            color: var(--gray-light);
        }
        
        .transaction-amount {
            font-weight: 700;
            color: var(--secondary);
            font-size: 1.1em;
        }
        
        .delete-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            margin-left: 10px;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .delete-btn:hover {
            background: #dc2626;
            transform: scale(1.05);
        }
        
        .empty-state {
            text-align: center;
            color: var(--gray);
            padding: 40px 20px;
        }
        
        .empty-state i {
            font-size: 3em;
            margin-bottom: 10px;
            opacity: 0.5;
        }
        
        .info-text {
            font-size: 12px;
            color: var(--gray-light);
            text-align: center;
            margin-top: 10px;
            line-height: 1.4;
        }
        
        .month-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .month-selector select {
            flex: 1;
        }
        
        .settings-section {
            background: var(--darker);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
        }
        
        .settings-section h3 {
            margin-bottom: 15px;
            color: var(--light);
            font-size: 1.1em;
            font-weight: 600;
        }
        
        .telegram-info {
            background: var(--info);
            color: white;
            padding: 12px;
            border-radius: 12px;
            margin: 10px 0;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .export-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }
        
        .export-btn {
            padding: 12px;
            text-align: center;
            background: var(--info);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .export-btn.excel {
            background: var(--secondary);
        }
        
        .export-btn.csv {
            background: var(--warning);
        }
        
        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }
        
        .share-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }
        
        .share-btn {
            padding: 12px;
            text-align: center;
            background: var(--info);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .share-btn.whatsapp {
            background: #25D366;
        }
        
        .share-btn.telegram {
            background: #0088cc;
        }
        
        .share-btn.email {
            background: #D44638;
        }
        
        .share-btn.copy {
            background: var(--primary);
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--secondary);
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1000;
            display: none;
            animation: slideIn 0.3s ease;
            font-weight: 600;
            max-width: 300px;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            color: var(--light);
        }
        
        .checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin: 0;
        }
        
        .pwa-badge {
            background: var(--primary);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .install-guide {
            background: var(--info);
            color: white;
            padding: 12px;
            border-radius: 12px;
            margin: 10px 0;
            font-size: 12px;
            line-height: 1.4;
        }
        
        /* Responsive */
        @media (max-width: 480px) {
            .container {
                padding: 15px;
                border-radius: 16px;
            }
            
            .month-summary {
                grid-template-columns: 1fr;
            }
            
            .export-options, .share-options {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .header {
                flex-wrap: wrap;
                gap: 10px;
            }
        }

        @media (max-height: 700px) {
            .container {
                padding: 15px;
            }
            
            .input-section {
                padding: 15px;
            }
            
            .transactions {
                max-height: 250px;
            }
        }

        /* Print Styles */
        @media print {
            .tab-navigation, .install-btn, .theme-toggle, .delete-btn {
                display: none !important;
            }
            
            .tab-content {
                display: block !important;
            }
            
            body {
                background: white;
                color: black;
                padding: 10px;
            }
            
            .container {
                box-shadow: none;
                border: 1px solid #ccc;
            }
        }
    </style>
</head>
<body data-theme="dark">
    <div class="notification" id="notification"></div>
    
    <div class="container">
        <div class="header">
            <button class="install-btn" id="installButton">üì± Install App</button>
            <div style="display: flex; align-items: center;">
                <h1>üìä Pembukuan Bulanan</h1>
                <span class="pwa-badge">PWA</span>
            </div>
            <button class="theme-toggle" onclick="toggleTheme()">üåô</button>
        </div>
        
        <div class="tab-navigation">
            <button class="tab-button active" onclick="switchTab('input')">Input</button>
            <button class="tab-button" onclick="switchTab('current')">Bulan Ini</button>
            <button class="tab-button" onclick="switchTab('reports')">Laporan</button>
            <button class="tab-button" onclick="switchTab('settings')">Settings</button>
        </div>
        
        <!-- Tab Input -->
        <div id="input-tab" class="tab-content active">
            <div class="input-section">
                <input type="text" id="transactionInput" placeholder="Contoh: remap beat 100rb" autofocus>
                <button onclick="addTransaction()">‚ûï Tambah Pendapatan</button>
                <p class="info-text">Contoh: "service motor 150rb", "jual aksesoris 50rb", "modif 2jt"</p>
            </div>
            
            <div class="month-summary">
                <div class="month-card previous">
                    <h3>üìÖ Bulan Lalu</h3>
                    <div class="amount" id="lastMonthTotal">Rp 0</div>
                </div>
                <div class="month-card current">
                    <h3>üí∞ Bulan Ini</h3>
                    <div class="amount" id="currentMonthTotal">Rp 0</div>
                </div>
            </div>
        </div>
        
        <!-- Tab Bulan Ini -->
        <div id="current-tab" class="tab-content">
            <div class="summary">
                <div>Total Pendapatan Bulan Ini</div>
                <div class="total" id="currentMonthDetailed">Rp 0</div>
            </div>
            
            <div class="transactions" id="currentMonthList">
                <div class="empty-state">
                    <div>üì≠</div>
                    <div>Belum ada transaksi bulan ini</div>
                </div>
            </div>
        </div>
        
        <!-- Tab Laporan -->
        <div id="reports-tab" class="tab-content">
            <div class="month-selector">
                <select id="reportMonth">
                    <!-- Options akan diisi oleh JavaScript -->
                </select>
                <select id="reportYear">
                    <!-- Options akan diisi oleh JavaScript -->
                </select>
            </div>
            
            <div class="summary">
                <div>Total Bulan Terpilih</div>
                <div class="total" id="selectedMonthTotal">Rp 0</div>
            </div>
            
            <div class="transactions" id="reportList">
                <div class="empty-state">
                    <div>üìä</div>
                    <div>Pilih bulan dan tahun</div>
                </div>
            </div>
            
            <div class="export-options">
                <button class="export-btn excel" onclick="exportSelectedMonth('excel')">üìó Export Excel</button>
                <button class="export-btn csv" onclick="exportSelectedMonth('csv')">üìò Export CSV</button>
            </div>
            
            <div class="share-options">
                <button class="share-btn copy" onclick="copyReportToClipboard()">üìã Copy Laporan</button>
                <button class="share-btn whatsapp" onclick="shareToWhatsApp()">üíö WhatsApp</button>
                <button class="share-btn telegram" onclick="shareToTelegram()">üì± Telegram</button>
                <button class="share-btn email" onclick="sendEmailReport()">üìß Email</button>
            </div>
        </div>
        
        <!-- Tab Settings -->
        <div id="settings-tab" class="tab-content">
            <div class="settings-section">
                <h3>üì± Install Aplikasi</h3>
                <button class="install-btn" id="manualInstallButton">üì≤ Install ke Home Screen</button>
                <div class="install-guide">
                    üí° <strong>Cara Install:</strong><br>
                    ‚Ä¢ <strong>Android:</strong> Menu ‚Üí Add to Home Screen<br>
                    ‚Ä¢ <strong>iOS:</strong> Share ‚Üí Add to Home Screen<br>
                    ‚Ä¢ <strong>Desktop:</strong> Klik Install button
                </div>
            </div>
            
            <div class="settings-section">
                <h3>‚öôÔ∏è Pengaturan Email</h3>
                <input type="email" id="emailAddress" placeholder="Alamat email tujuan">
                <button onclick="saveEmailSettings()">üíæ Simpan Email</button>
            </div>
            
            <div class="settings-section">
                <h3>ü§ñ Pengaturan WhatsApp</h3>
                <input type="text" id="whatsappNumber" placeholder="Nomor WhatsApp (62812...)">
                <button onclick="saveWhatsAppSettings()">üíæ Simpan WhatsApp</button>
                <p class="info-text">Format: 6281234567890 (tanpa +)</p>
            </div>
            
            <div class="settings-section">
                <h3>üìä Auto-Export Settings</h3>
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="autoExport" checked> 
                        Auto-export saat ganti bulan
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="autoSendEmail"> 
                        Auto-kirim email
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="autoSendWhatsApp"> 
                        Auto-kirim WhatsApp
                    </label>
                </div>
                <button onclick="saveExportSettings()">üíæ Simpan Settings</button>
            </div>
            
            <div class="settings-section">
                <h3>üõ†Ô∏è Tools</h3>
                <button onclick="clearCurrentMonth()" style="background: var(--warning);">üóëÔ∏è Hapus Bulan Ini</button>
                <button onclick="exportAllData('excel')" style="background: var(--secondary); margin-top: 5px;">üìó Export Semua Data (Excel)</button>
                <button onclick="exportAllData('csv')" style="background: var(--warning); margin-top: 5px;">üìò Export Semua Data (CSV)</button>
                <button onclick="backupData()" style="background: #9C27B0; margin-top: 5px;">üíæ Backup Data</button>
                <button onclick="restoreData()" style="background: #607D8B; margin-top: 5px;">üì• Restore Data</button>
                <button onclick="printReport()" style="background: #6B7280; margin-top: 5px;">üñ®Ô∏è Print Laporan</button>
            </div>

            <div class="settings-section">
                <h3>üìä App Info</h3>
                <div class="info-text">
                    <p><strong>Status:</strong> <span id="pwaStatus">Loading...</span></p>
                    <p><strong>Transaksi:</strong> <span id="transactionCount">0</span> data</p>
                    <p><strong>Versi:</strong> 2.0.0</p>
                </div>
                <button onclick="clearAllData()" style="background: var(--danger); margin-top: 10px;">üóëÔ∏è Hapus Semua Data</button>
            </div>
        </div>
    </div>

    <script>
        // ===== PWA INSTALL FUNCTIONALITY =====
        let deferredPrompt;
        const installButton = document.getElementById('installButton');
        const manualInstallButton = document.getElementById('manualInstallButton');

        // Enhanced PWA Install Logic
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('PWA Install Prompt Available');
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install buttons
            installButton.style.display = 'block';
            manualInstallButton.style.display = 'block';
            
            updatePWAStatus('Siap diinstall');
        });

        // Auto install button
        installButton.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                
                if (outcome === 'accepted') {
                    showNotification('Aplikasi berhasil diinstall! üéâ');
                    installButton.classList.add('hidden');
                    manualInstallButton.classList.add('hidden');
                    updatePWAStatus('Terinstall');
                }
                deferredPrompt = null;
            } else {
                showManualInstallGuide();
            }
        });

        // Manual install button
        manualInstallButton.addEventListener('click', () => {
            showManualInstallGuide();
        });

        function showManualInstallGuide() {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isAndroid = /Android/.test(navigator.userAgent);
            
            let message = '';
            if (isIOS) {
                message = 'üì± iOS: Tap share icon (‚éó) ‚Üí "Add to Home Screen" ‚Üí "Add"';
            } else if (isAndroid) {
                message = 'üì± Android: Tap menu (‚ãÆ) ‚Üí "Add to Home Screen" ‚Üí "Add"';
            } else {
                message = 'üíª Desktop: Klik install button di address bar browser';
            }
            
            showNotification(message, 'info');
        }

        // Check if app is already installed
        window.addEventListener('appinstalled', () => {
            console.log('PWA Installed');
            installButton.classList.add('hidden');
            manualInstallButton.classList.add('hidden');
            deferredPrompt = null;
            updatePWAStatus('Terinstall');
        });

        // Check on load if already installed
        if (window.matchMedia('(display-mode: standalone)').matches) {
            installButton.classList.add('hidden');
            manualInstallButton.classList.add('hidden');
            updatePWAStatus('Terinstall');
        }

        function updatePWAStatus(status) {
            document.getElementById('pwaStatus').textContent = status;
        }

        // ===== CORE APP FUNCTIONALITY =====
        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        let lastExportMonth = localStorage.getItem('lastExportMonth') || '';
        let settings = JSON.parse(localStorage.getItem('appSettings')) || {
            email: '',
            whatsappNumber: '',
            autoExport: true,
            autoSendEmail: false,
            autoSendWhatsApp: false,
            theme: 'dark'
        };

        // Inisialisasi Aplikasi
        function initializeApp() {
            loadSettings();
            applyTheme();
            checkAutoExport();
            renderAll();
            setupMonthYearSelectors();
            setupEventListeners();
            updatePWAStatus('Aktif');
            updateTransactionCount();
            
            console.log('Aplikasi Pembukuan siap!');
            showNotification('Aplikasi siap! üöÄ');
        }

        // Theme Management
        function toggleTheme() {
            const currentTheme = document.body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.body.setAttribute('data-theme', newTheme);
            settings.theme = newTheme;
            saveSettings();
            
            const themeBtn = document.querySelector('.theme-toggle');
            themeBtn.textContent = newTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
            showNotification(`Tema ${newTheme === 'dark' ? 'Gelap' : 'Terang'} diaktifkan`);
        }

        function applyTheme() {
            document.body.setAttribute('data-theme', settings.theme);
            const themeBtn = document.querySelector('.theme-toggle');
            themeBtn.textContent = settings.theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
        }

        // Tab Management
        function switchTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`.tab-button:nth-child(${getTabIndex(tabName)})`).classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
            
            if (tabName === 'reports') loadReportView();
            if (tabName === 'input') document.getElementById('transactionInput').focus();
        }

        function getTabIndex(tabName) {
            const tabs = { 'input': 1, 'current': 2, 'reports': 3, 'settings': 4 };
            return tabs[tabName] || 1;
        }

        // Settings Management
        function loadSettings() {
            document.getElementById('emailAddress').value = settings.email || '';
            document.getElementById('whatsappNumber').value = settings.whatsappNumber || '';
            document.getElementById('autoExport').checked = settings.autoExport;
            document.getElementById('autoSendEmail').checked = settings.autoSendEmail;
            document.getElementById('autoSendWhatsApp').checked = settings.autoSendWhatsApp;
        }

        function saveEmailSettings() {
            settings.email = document.getElementById('emailAddress').value;
            saveSettings();
            showNotification('Email berhasil disimpan!');
        }

        function saveWhatsAppSettings() {
            settings.whatsappNumber = document.getElementById('whatsappNumber').value;
            saveSettings();
            showNotification('Nomor WhatsApp disimpan!');
        }

        function saveExportSettings() {
            settings.autoExport = document.getElementById('autoExport').checked;
            settings.autoSendEmail = document.getElementById('autoSendEmail').checked;
            settings.autoSendWhatsApp = document.getElementById('autoSendWhatsApp').checked;
            saveSettings();
            showNotification('Export settings disimpan!');
        }

        function saveSettings() {
            localStorage.setItem('appSettings', JSON.stringify(settings));
        }

        // Transaction Management
        function addTransaction() {
            const input = document.getElementById('transactionInput');
            const text = input.value.trim();
            
            if (!text) {
                showNotification('Masukkan deskripsi dan jumlah!', 'warning');
                return;
            }
            
            const amount = parseAmount(text);
            if (amount === 0) {
                showNotification('Format jumlah tidak valid! Contoh: "remap beat 100rb"', 'warning');
                return;
            }
            
            const description = extractDescription(text) || 'Pendapatan';
            const now = new Date();
            
            const transaction = {
                id: Date.now(),
                description: description,
                amount: amount,
                date: now.toISOString().split('T')[0],
                displayDate: now.toLocaleDateString('id-ID')
            };
            
            transactions.unshift(transaction);
            saveTransactions();
            renderAll();
            
            input.value = '';
            input.focus();
            showNotification('Transaksi berhasil ditambahkan!');
        }

        function parseAmount(text) {
            text = text.toLowerCase().replace(/\s/g, '');
            const match = text.match(/(\d+)(rb|k|ribu|ratus|jt|juta)/);
            
            if (match) {
                const number = parseInt(match[1]);
                const unit = match[2];
                const multipliers = { 'rb': 1000, 'k': 1000, 'ribu': 1000, 'ratus': 100000, 'jt': 1000000, 'juta': 1000000 };
                return number * (multipliers[unit] || 1);
            }
            
            const numberMatch = text.match(/\d+/);
            return numberMatch ? parseInt(numberMatch[0]) : 0;
        }

        function extractDescription(text) {
            return text.replace(/\d+(rb|k|ribu|ratus|jt|juta)?/gi, '').trim();
        }

        function deleteTransaction(id) {
            if (confirm('Hapus transaksi ini?')) {
                transactions = transactions.filter(t => t.id !== id);
                saveTransactions();
                renderAll();
                showNotification('Transaksi dihapus!');
            }
        }

        function clearCurrentMonth() {
            const current = getCurrentMonth();
            const currentMonthData = getTransactionsByMonth(current.year, current.month);
            
            if (currentMonthData.length === 0) {
                showNotification('Tidak ada transaksi bulan ini!', 'warning');
                return;
            }
            
            if (confirm(`Hapus semua transaksi bulan ini (${currentMonthData.length} transaksi)?`)) {
                transactions = transactions.filter(t => {
                    const date = new Date(t.date);
                    return !(date.getFullYear() === current.year && date.getMonth() + 1 === current.month);
                });
                saveTransactions();
                renderAll();
                showNotification('Semua transaksi bulan ini dihapus!');
            }
        }

        function saveTransactions() {
            localStorage.setItem('transactions', JSON.stringify(transactions));
            updateTransactionCount();
        }

        function updateTransactionCount() {
            document.getElementById('transactionCount').textContent = transactions.length;
        }

        // Data Export & Reporting
        function checkAutoExport() {
            if (!settings.autoExport) return;
            
            const now = new Date();
            const currentMonth = now.getFullYear() + '-' + (now.getMonth() + 1);
            
            if (lastExportMonth && lastExportMonth !== currentMonth && transactions.length > 0) {
                const lastMonth = getPreviousMonth();
                const lastMonthData = getTransactionsByMonth(lastMonth.year, lastMonth.month);
                
                if (lastMonthData.length > 0) {
                    autoExportLastMonth(lastMonth.year, lastMonth.month, lastMonthData);
                }
            }
            
            lastExportMonth = currentMonth;
            localStorage.setItem('lastExportMonth', currentMonth);
        }

        function autoExportLastMonth(year, month, data) {
            const monthName = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                              'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'][month - 1];
            
            const excelData = generateExcelData(data, monthName, year);
            const blob = new Blob([excelData], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            downloadFile(blob, `Laporan_${monthName}_${year}.xlsx`);
            
            showNotification(`Laporan ${monthName} ${year} telah diexport otomatis!`);
        }

        function generateExcelData(data, monthName, year) {
            const total = data.reduce((sum, t) => sum + t.amount, 0);
            let content = `LAPORAN PENDAPATAN ${monthName.toUpperCase()} ${year}\n\nTanggal\tDeskripsi\tJumlah\n`;
            data.forEach(t => content += `${t.displayDate}\t${t.description}\t${t.amount}\n`);
            content += `\nTOTAL\t\t${total}`;
            return content;
        }

        function generateCSVData(data) {
            let csv = 'Tanggal,Deskripsi,Jumlah\n';
            const total = data.reduce((sum, t) => sum + t.amount, 0);
            data.forEach(t => csv += `"${t.displayDate}","${t.description}",${t.amount}\n`);
            csv += `\nTotal,,${total}`;
            return csv;
        }

        function downloadFile(blob, filename) {
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function exportSelectedMonth(format) {
            const month = parseInt(document.getElementById('reportMonth').value);
            const year = parseInt(document.getElementById('reportYear').value);
            const data = getTransactionsByMonth(year, month);
            
            if (data.length === 0) {
                showNotification('Tidak ada data untuk diexport!', 'warning');
                return;
            }
            
            const monthName = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                              'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'][month - 1];
            
            if (format === 'excel') {
                const excelData = generateExcelData(data, monthName, year);
                const blob = new Blob([excelData], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                downloadFile(blob, `Laporan_${monthName}_${year}.xlsx`);
            } else {
                const csvData = generateCSVData(data);
                const blob = new Blob([csvData], { type: 'text/csv' });
                downloadFile(blob, `Laporan_${monthName}_${year}.csv`);
            }
            
            showNotification(`Laporan ${monthName} ${year} berhasil diexport!`);
        }

        function exportAllData(format) {
            if (transactions.length === 0) {
                showNotification('Tidak ada data untuk diexport!', 'warning');
                return;
            }
            
            const dateStr = new Date().toISOString().split('T')[0];
            if (format === 'excel') {
                const excelData = generateExcelData(transactions, 'Semua', 'Data');
                const blob = new Blob([excelData], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                downloadFile(blob, `Laporan_Semua_Data_${dateStr}.xlsx`);
            } else {
                const csvData = generateCSVData(transactions);
                const blob = new Blob([csvData], { type: 'text/csv' });
                downloadFile(blob, `Laporan_Semua_Data_${dateStr}.csv`);
            }
            
            showNotification('Semua data berhasil diexport!');
        }

        // Sharing Functions
        function generateReportMessage() {
            const month = parseInt(document.getElementById('reportMonth').value);
            const year = parseInt(document.getElementById('reportYear').value);
            const data = getTransactionsByMonth(year, month);
            const monthName = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                              'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'][month - 1];
            const total = data.reduce((sum, t) => sum + t.amount, 0);
            
            return `üìä LAPORAN PENDAPATAN ${monthName.toUpperCase()} ${year}

üí∞ TOTAL: Rp ${total.toLocaleString('id-ID')}

üìã DETAIL TRANSAKSI:
${data.map((t, i) => `${i+1}. ${t.displayDate} - ${t.description} - Rp ${t.amount.toLocaleString('id-ID')}`).join('\n')}

_Generated by Pembukuan App_`;
        }

        function copyReportToClipboard() {
            const message = generateReportMessage();
            navigator.clipboard.writeText(message).then(() => {
                showNotification('Laporan disalin ke clipboard! üìã');
            }).catch(() => {
                // Fallback
                const textArea = document.createElement('textarea');
                textArea.value = message;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showNotification('Laporan disalin! üìã');
            });
        }

        function shareToWhatsApp() {
            const message = generateReportMessage();
            const encoded = encodeURIComponent(message);
            const url = settings.whatsappNumber ? 
                `https://api.whatsapp.com/send?phone=${settings.whatsappNumber}&text=${encoded}` :
                `https://wa.me/?text=${encoded}`;
            window.open(url, '_blank');
            showNotification('Membuka WhatsApp... üíö');
        }

        function shareToTelegram() {
            const message = generateReportMessage();
            const encoded = encodeURIComponent(message);
            const url = `https://t.me/share/url?text=${encoded}`;
            window.open(url, '_blank');
            showNotification('Membuka Telegram... üì±');
        }

        function sendEmailReport() {
            const message = generateReportMessage();
            const month = parseInt(document.getElementById('reportMonth').value);
            const year = parseInt(document.getElementById('reportYear').value);
            const monthName = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                              'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'][month - 1];
            
            const subject = `Laporan Pendapatan ${monthName} ${year}`;
            const body = message;
            
            const mailto = settings.email ? 
                `mailto:${settings.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}` :
                `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            
            window.location.href = mailto;
        }

        // Backup & Restore
        function backupData() {
            const backup = { transactions, settings, timestamp: new Date().toISOString() };
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            downloadFile(blob, `backup_pembukuan_${new Date().toISOString().split('T')[0]}.json`);
            showNotification('Backup data berhasil!');
        }

        function restoreData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = e => {
                    try {
                        const backup = JSON.parse(e.target.result);
                        if (confirm('Restore data? Data saat ini akan diganti.')) {
                            transactions = backup.transactions || [];
                            settings = { ...settings, ...backup.settings };
                            saveTransactions();
                            saveSettings();
                            renderAll();
                            loadSettings();
                            showNotification('Data berhasil di-restore!');
                        }
                    } catch {
                        showNotification('File backup tidak valid!', 'warning');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function clearAllData() {
            if (confirm('HAPUS SEMUA DATA? Tindakan ini tidak dapat dibatalkan!')) {
                localStorage.clear();
                transactions = [];
                settings = { email: '', whatsappNumber: '', autoExport: true, autoSendEmail: false, autoSendWhatsApp: false, theme: 'dark' };
                renderAll();
                loadSettings();
                showNotification('Semua data telah dihapus üóëÔ∏è');
            }
        }

        function printReport() {
            window.print();
        }

        // UI Rendering
        function renderAll() {
            updateSummaryCards();
            renderCurrentMonth();
            loadReportView();
            updateTransactionCount();
        }

        function updateSummaryCards() {
            const current = getCurrentMonth();
            const previous = getPreviousMonth();
            
            const currentTotal = getTransactionsByMonth(current.year, current.month).reduce((sum, t) => sum + t.amount, 0);
            const previousTotal = getTransactionsByMonth(previous.year, previous.month).reduce((sum, t) => sum + t.amount, 0);
            
            document.getElementById('currentMonthTotal').textContent = formatNumber(currentTotal);
            document.getElementById('lastMonthTotal').textContent = formatNumber(previousTotal);
        }

        function renderCurrentMonth() {
            const current = getCurrentMonth();
            const data = getTransactionsByMonth(current.year, current.month);
            const total = data.reduce((sum, t) => sum + t.amount, 0);
            
            document.getElementById('currentMonthDetailed').textContent = formatNumber(total);
            
            const container = document.getElementById('currentMonthList');
            if (data.length === 0) {
                container.innerHTML = '<div class="empty-state"><div>üì≠</div><div>Belum ada transaksi bulan ini</div></div>';
            } else {
                container.innerHTML = data.map(t => `
                    <div class="transaction-item">
                        <div class="transaction-desc">
                            <strong>${t.description}</strong>
                            <div class="transaction-date">${t.displayDate}</div>
                        </div>
                        <div class="transaction-amount">${formatNumber(t.amount)}</div>
                        <button class="delete-btn" onclick="deleteTransaction(${t.id})">Hapus</button>
                    </div>
                `).join('');
            }
        }

        // Helper Functions
        function formatNumber(num) {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(num);
        }

        function getCurrentMonth() {
            const now = new Date();
            return { year: now.getFullYear(), month: now.getMonth() + 1 };
        }

        function getPreviousMonth() {
            const now = new Date();
            let year = now.getFullYear();
            let month = now.getMonth();
            if (month === 0) { month = 12; year--; }
            return { year, month };
        }

        function getTransactionsByMonth(year, month) {
            return transactions.filter(t => {
                const date = new Date(t.date);
                return date.getFullYear() === year && date.getMonth() + 1 === month;
            });
        }

        function setupMonthYearSelectors() {
            const monthSelect = document.getElementById('reportMonth');
            const yearSelect = document.getElementById('reportYear');
            
            monthSelect.innerHTML = '';
            yearSelect.innerHTML = '';
            
            ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember']
                .forEach((month, i) => {
                    const option = document.createElement('option');
                    option.value = i + 1;
                    option.textContent = month;
                    monthSelect.appendChild(option);
                });
            
            const currentYear = new Date().getFullYear();
            for (let year = currentYear; year >= currentYear - 5; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }
            
            const current = getCurrentMonth();
            monthSelect.value = current.month;
            yearSelect.value = current.year;
        }

        function loadReportView() {
            const month = parseInt(document.getElementById('reportMonth').value);
            const year = parseInt(document.getElementById('reportYear').value);
            const data = getTransactionsByMonth(year, month);
            const total = data.reduce((sum, t) => sum + t.amount, 0);
            
            document.getElementById('selectedMonthTotal').textContent = formatNumber(total);
            
            const container = document.getElementById('reportList');
            if (data.length === 0) {
                container.innerHTML = '<div class="empty-state"><div>üìä</div><div>Tidak ada transaksi di bulan ini</div></div>';
            } else {
                container.innerHTML = data.map(t => `
                    <div class="transaction-item">
                        <div class="transaction-desc">
                            <strong>${t.description}</strong>
                            <div class="transaction-date">${t.displayDate}</div>
                        </div>
                        <div class="transaction-amount">${formatNumber(t.amount)}</div>
                    </div>
                `).join('');
            }
        }

        // Event Listeners
        function setupEventListeners() {
            // Keyboard
            document.getElementById('transactionInput').addEventListener('keypress', e => {
                if (e.key === 'Enter') addTransaction();
            });

            document.addEventListener('keydown', e => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                    e.preventDefault();
                    document.getElementById('transactionInput').focus();
                }
                if (e.key === 'Escape') {
                    document.getElementById('transactionInput').value = '';
                }
                if (e.key >= '1' && e.key <= '4' && !e.ctrlKey && !e.metaKey) {
                    e.preventDefault();
                    const tabs = ['input', 'current', 'reports', 'settings'];
                    switchTab(tabs[parseInt(e.key) - 1]);
                }
            });

            // Settings
            document.getElementById('autoExport').addEventListener('change', function() {
                settings.autoExport = this.checked;
                saveSettings();
            });
            document.getElementById('autoSendEmail').addEventListener('change', function() {
                settings.autoSendEmail = this.checked;
                saveSettings();
            });
            document.getElementById('autoSendWhatsApp').addEventListener('change', function() {
                settings.autoSendWhatsApp = this.checked;
                saveSettings();
            });

            document.getElementById('emailAddress').addEventListener('blur', function() {
                if (this.value !== settings.email) {
                    settings.email = this.value;
                    saveSettings();
                    showNotification('Email disimpan!');
                }
            });

            document.getElementById('whatsappNumber').addEventListener('blur', function() {
                if (this.value !== settings.whatsappNumber) {
                    settings.whatsappNumber = this.value;
                    saveSettings();
                    showNotification('Nomor WhatsApp disimpan!');
                }
            });

            // Selectors
            document.getElementById('reportMonth').addEventListener('change', loadReportView);
            document.getElementById('reportYear').addEventListener('change', loadReportView);

            // Input validation
            document.getElementById('transactionInput').addEventListener('input', function(e) {
                const amount = parseAmount(e.target.value);
                this.style.borderColor = amount > 0 ? 'var(--secondary)' : 'var(--border)';
            });
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.background = type === 'success' ? 'var(--secondary)' : 
                                          type === 'warning' ? 'var(--warning)' : 'var(--info)';
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>ni',
        'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'
    ];
    
    months.forEach((month, index) => {
        const option = document.createElement('option');
        option.value = index + 1;
        option.textContent = month;
        monthSelect.appendChild(option);
    });
    
    const currentYear = new Date().getFullYear();
    for (let year = currentYear; year >= currentYear - 5; year--) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
    }
    
    // Set default ke bulan dan tahun saat ini
    const current = getCurrentMonth();
    monthSelect.value = current.month;
    yearSelect.value = current.year;
}

function loadReportView() {
    const month = parseInt(document.getElementById('reportMonth').value);
    const year = parseInt(document.getElementById('reportYear').value);
    
    const monthData = getTransactionsByMonth(year, month);
    const container = document.getElementById('reportList');
    const totalElement = document.getElementById('selectedMonthTotal');
    
    const total = monthData.reduce((sum, t) => sum + t.amount, 0);
    totalElement.textContent = formatNumber(total);
    
    if (monthData.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div>üìä</div>
                <div>Tidak ada transaksi di bulan ini</div>
            </div>
        `;
        return;
    }
    
    container.innerHTML = monthData.map(transaction => `
        <div class="transaction-item">
            <div class="transaction-desc">
                <strong>${transaction.description}</strong>
                <div class="transaction-date">${transaction.displayDate}</div>
            </div>
            <div class="transaction-amount">${formatNumber(transaction.amount)}</div>
        </div>
    `).join('');
}

function showNotification(message, type = 'success') {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.style.background = type === 'success' ? 'var(--secondary)' : 
                                  type === 'warning' ? 'var(--warning)' : 'var(--danger)';
    notification.style.display = 'block';
    
    setTimeout(() => {
        notification.style.display = 'none';
    }, 3000);
}

// Initialize app when page loads
document.addEventListener('DOMContentLoaded', initializeApp);

// Prevent drag and drop of files
document.addEventListener('drop', function(e) {
    e.preventDefault();
});

document.addEventListener('dragover', function(e) {
    e.preventDefault();
});
    </script>
</body>
</html>